app-id: org.texstudio.TeXstudio
runtime: org.kde.Platform
runtime-version: '5.11'
sdk: org.kde.Sdk
command: texstudio
rename-icon: texstudio
rename-appdata-file: texstudio.appdata.xml
rename-desktop-file: texstudio.desktop
finish-args:
  # - --socket=wayland (disabled until Qt 5.12 is relased)
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --filesystem=host # lets LuaLaTeX etc. write output files, even if the document is stored outside of ~
  - --filesystem=xdg-config/kdeglobals:ro # gives application access to kdeglobals
  - --talk-name=com.canonical.AppMenu.Registrar # gives application access to dbus menu
  - --share=network # required for LanguageTool
  - --env=PATH=/usr/bin:/app/bin:/app/bin/x86_64-linux
  - --env=TEXMFCACHE=$XDG_CACHE_HOME
  - --env=LC_ALL=C # works around LuaLaTex issue with locale
  - --env=TEXINPUTS=.:~/texmf/:
build-options:
  cflags: -O2
  cxxflags: -O2
  env:
    LD_LIBRARY_PATH: /app/lib:/app/lib64
modules:

- name: openjpeg # build dependency of poppler
  buildsystem: cmake-ninja
  sources:
    - type: archive
      url: https://github.com/uclouvain/openjpeg/archive/v2.3.0.tar.gz
      sha256: 3dc787c1bb6023ba846c2a0d9b1f6e179f1cd255172bde9eb75b01f1e6c7d71a

- name: poppler # build dependency of TeXstudio
  buildsystem: cmake-ninja
  config-opts:
    - -DCMAKE_BUILD_TYPE=release
    - -DENABLE_QT5:BOOL=true
    - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
  sources:
    - type: archive
      url: https://poppler.freedesktop.org/poppler-0.69.0.tar.xz
      sha256: 637ff943f805f304ff1da77ba2e7f1cbd675f474941fd8ae1e0fc01a5b45a3f9

- name: texstudio
  buildsystem: qmake
  cleanup-platform:
    - /bin
    - /mkspecs
  sources:
    - type: archive
      url: https://github.com/texstudio-org/texstudio/archive/2.12.10.tar.gz
      sha256: 92cf9cbb536e58a5929611fa40438cd9d7ea6880022cd3c5de0483fd15d3df0b
    - type: patch
      path: konsole.patch
  post-install:
    - sed -i 's|texstudio.desktop|org.texstudio.TeXstudio.desktop|g' /app/share/appdata/texstudio.appdata.xml

- name: perl # required for makeglossaries
  no-autogen: true
  config-opts:
  - -des # use default build configuration
  - -Duseshrplib # build shared library
  build-options:
    cflags: -fPIC
    ldflags: -fpic
    no-debuginfo: true
  cleanup:
    - /man
    - "*.pod"
    - "*.h"
  sources:
  - type: archive
    url: https://www.cpan.org/src/5.0/perl-5.28.0.tar.gz
    sha256: 7e929f64d4cb0e9d1159d4a59fc89394e27fa1f7004d0836ca0d514685406ea8
  - type: script
    dest-filename: configure
    commands:
    - exec ./configure.gnu $@

- name: p7zip # required for unzipping texlive.iso
  no-autogen: true
  make-args:
    - 7z
  cleanup:
    - '*'
  sources:
    - type: archive
      url: https://sourceforge.net/projects/p7zip/files/p7zip/16.02/p7zip_16.02_src_all.tar.bz2
      sha256: 5eb20ac0e2944f6cb9c2d51dd6c4518941c185347d4089ea89087ffdd6e2341f
    - type: shell
      commands:
      - sed -i 's|/usr/local|/app|g' makefile.common

- name: wget # build dependency of TeX Live
  cleanup:
    - '*'
  sources:
    - type: archive
      url: https://ftp.gnu.org/gnu/wget/wget-1.19.tar.xz
      sha256: 0f1157bbf4daae19f3e1ddb70c6ccb2067feb834a6aa23c9d9daa7f048606384

- name: texlive
  buildsystem: simple
  sources:
    - type: file
      url: http://mirrors.ctan.org/systems/texlive/Images/texlive.iso
      sha512: 7b7f0dd0eab3bfffe52c5cd1139c7f75d029b9ff4c4ce0e57e06834705522f4ec0c02cd99a80b053c6619abda51c20a60f8e91e91781bdc2b9b60fc2e5708adb
  build-commands:
    - 7z x texlive.iso
    - chmod +x install-tl
    - "echo \"I\nn\" | TEXLIVE_INSTALL_PREFIX=/app ./install-tl -portable"
    - rm -rf /app/texmf-dist/doc

- name: konsole
  buildsystem: cmake-ninja
  sources:
    - url: https://github.com/KDE/konsole/archive/v18.08.1.tar.gz
      sha256: 25eb2b7c1e48ee5e62160bde835be8e8e15bc22c398fda20d1103a4ef9cef8b6
      type: archive

- name: ghostscript # required for including .eps graphics
  config-opts:
  - --disable-cups
  build-options:
    ldflags: -L/app/lib
  sources:
  - type: archive
    url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs926/ghostscript-9.26.tar.xz
    sha256: 90ed475f37584f646e9ef829932b2525d5c6fc2e0147e8d611bc50aa0e718598
