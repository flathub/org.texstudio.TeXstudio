app-id: org.texstudio.TeXstudio
runtime: org.kde.Platform
runtime-version: '5.13'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.texlive
  - org.freedesktop.Sdk.Extension.openjdk11
command: texstudio
rename-icon: texstudio
rename-appdata-file: texstudio.appdata.xml
rename-desktop-file: texstudio.desktop
finish-args:
#  - --socket=wayland (requires https://bugreports.qt.io/browse/QTBUG-68619 to be fixed)
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --filesystem=host # lets LuaLaTeX etc. write output files, even if the document is stored outside of ~
  - --filesystem=xdg-config/kdeglobals:ro # gives application access to kdeglobals
  - --talk-name=com.canonical.AppMenu.Registrar # gives application access to dbus menu
  - --share=network # required for LanguageTool
  - --env=TMPDIR=/var/tmp # for lockfiles
  - --env=PATH=/app/jre/bin:/usr/bin:/app/bin:/app/bin/x86_64-linux
  - --env=TEXMFCACHE=$XDG_CACHE_HOME
  - --env=LC_ALL=C # works around LuaLaTex issue with locale
  - --env=TEXINPUTS=.:~/texmf/:
build-options:
  env:
    LD_LIBRARY_PATH: /app/lib:/app/lib64
modules:
- name: texlive
  buildsystem: simple
  build-commands:
    - /usr/lib/sdk/texlive/install.sh

- name: openjdk
  buildsystem: simple
  build-commands:
    - /usr/lib/sdk/openjdk11/install.sh

- name: openjpeg # build dependency of poppler
  buildsystem: cmake-ninja
  sources:
    - type: archive
      url: https://github.com/uclouvain/openjpeg/archive/v2.3.1.tar.gz
      sha256: 63f5a4713ecafc86de51bfad89cc07bb788e9bba24ebbf0c4ca637621aadb6a9

- name: poppler # build dependency of TeXstudio
  buildsystem: cmake-ninja
  config-opts:
    - -DCMAKE_BUILD_TYPE=release
    - -DENABLE_QT5:BOOL=true
    - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
  sources:
    - type: archive
      url: https://poppler.freedesktop.org/poppler-0.82.0.tar.xz
      sha256: 234f8e573ea57fb6a008e7c1e56bfae1af5d1adf0e65f47555e1ae103874e4df

- name: texstudio
  buildsystem: qmake
  cleanup-platform:
    - /bin
    - /mkspecs
  sources:
    - type: archive
      url: https://github.com/texstudio-org/texstudio/archive/2.12.16.tar.gz
      sha256: a14b8912bfd15d982cfbe5f00deed37ca85fb6e38d3aa0c2dac23b4ecaab0984
    - type: patch
      path: konsole.patch
  post-install:
    - sed -i 's|texstudio.desktop|org.texstudio.TeXstudio.desktop|g' /app/share/appdata/texstudio.appdata.xml

- name: konsole
  buildsystem: cmake-ninja
  sources:
    - url: https://github.com/KDE/konsole/archive/v19.08.2.tar.gz
      sha256: 93fceb0e8b031f27eb9764ea3d5c663c227de952ea90ebcafa7a3bcabcb25283
      type: archive

- name: languagetool
  buildsystem: simple
  build-commands:
    - mkdir /app/languagetool
    - cp -r * /app/languagetool
  sources:
    - url: https://github.com/languagetool-org/languagetool/archive/v4.7.tar.gz
      type: archive
      sha256: 224fbc7e3c6973cf63ee5b9ad9392b505c9294238f4d3a387d3c41b7b9e556e1
  cleanup:
    - /app/languagetool/testrules.*
    - /app/languagetool/languagetool-commandline.jar
